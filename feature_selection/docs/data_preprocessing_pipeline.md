# 藻类脂质含量预测 — 数据处理说明

本文档记录了从原始数据到特征筛选的完整处理流程。所有代码实现见 `notebooks/00_full_pipeline.ipynb`。

## 数据概况

我们的目标是预测藻类的脂质含量 `lipid(%)`。原始数据包含 36 个样本、29 个特征，来源于实验室培养的藻类样本。

数据存在少量缺失：phosphate 缺 8 个，N(%)、C(%)、S(%) 各缺 2 个。样本量较小，因此后续处理中尽量保守，避免丢失数据。

---

## 处理步骤

### 第一步：缺失值填充

4 个特征存在缺失值，均采用**中位数**填充。选择中位数而非均值，是因为 phosphate 分布严重右偏（偏度 3.23），中位数更能代表典型值。

填充情况：
- **phosphate**：8 个缺失 → 填充为 0.022
- **N(%)**：2 个缺失 → 填充为 3.70
- **C(%)**：2 个缺失 → 填充为 45.91
- **S(%)**：2 个缺失 → 填充为 0.40

填充后，phosphate 的均值下降了约 18%（从 0.123 降到 0.101），这是预期内的，因为原有数据中高值样本较多。其他三个特征变化很小（<2%）。

→ 输出：`data/processed/data_cleaned.xlsx`

---

### 第二步：特征工程

基于领域知识，构造了 3 个比例特征：

1. **碳氮比 (C_N_ratio)** = C(%) / N(%)
   - 氮源受限时碳源流向脂质合成，C/N 比是脂质积累的经典指标

2. **氮磷比 (N_P_ratio)** = TN / TP
   - 反映水体营养结构，类似 Redfield 比的概念

3. **氮磷转化效率比 (N_P_conv_ratio)** = N 转化率 / P 转化率
   - 探索性指标，反映藻类对氮磷的吸收偏好

计算时做了保护处理：当分母为 0 或接近 0 时，结果设为 NaN，再用中位数填充。这避免了除零错误和极端值。

→ 输出：`data/processed/data_featured.xlsx`（32 个特征）

---

### 第三步：异常值处理

采用**盖帽法 (Winsorization)**，将极端值拉回到合理范围，而不是直接删除。这对小样本数据很重要。

判定规则：
- 下界 = Q1 − 2.5 × IQR
- 上界 = Q3 + 2.5 × IQR

选择 2.5 倍 IQR（而非常见的 1.5 倍）是为了只处理真正的极端值，保持数据的自然变异。

共有 10 个特征检测到异常值，主要是上界超限。例如：
- phosphate 有 8 个高值被盖帽（最大值从 1.315 降到 0.077）
- TP 有 6 个高值被盖帽（最大值从 6.50 降到 0.83）
- protein(%) 有 8 个高值被盖帽

处理后样本量保持 36，没有丢失任何数据。

→ 输出：`data/processed/data_final.xlsx`

---

### 第四步：标准化

对所有特征做 Z-score 标准化，使其均值为 0、标准差为 1。这是为后续建模做准备，消除量纲影响。

标准化公式：z = (x − μ) / σ

注意：目标变量 `lipid(%)` 不参与标准化，保持原始值。

→ 输出：`data/processed/data_standardized.xlsx`

---

### 第五步：特征筛选

用四种方法评估特征重要性，然后综合排名：

**方法 1：Pearson 相关系数**
直接计算每个特征与 lipid(%) 的线性相关程度。简单直观，但只能捕捉线性关系。

**方法 2：随机森林**
训练 100 棵树（max_depth=3），根据特征在分裂时的信息增益计算重要性。能捕捉非线性关系。

**方法 3：PLS 回归 (VIP 得分)**
偏最小二乘回归，计算每个特征对潜变量的贡献。VIP > 1 通常认为是重要特征。

**方法 4：递归特征消除 (RFE)**
基于 Ridge 回归，逐步剔除最不重要的特征，最终保留 6 个。排名越靠前说明越晚被剔除，越重要。

#### 综合结果

四种方法的结果归一化后取平均，得到最终排名。前 10 个推荐特征：

| 排名 | 特征 | 说明 |
|:----:|------|------|
| 1 | H(%) | 氢含量，四种方法一致排第一 |
| 2 | O(%) | 氧含量 |
| 3 | protein(%) | 蛋白质含量 |
| 4 | Total photosynthetic pigments | 光合色素总量 |
| 5 | pH | 培养液酸碱度 |
| 6 | COD | 化学需氧量 |
| 7 | BOD | 生化需氧量 |
| 8 | Dry cell weight | 干细胞重量 |
| 9 | DO | 溶解氧 |
| 10 | phosphate | 磷酸盐 |

H(%) 和 O(%) 稳居前两位，这与脂质分子的化学组成（富含 C、H、O）相符。蛋白质含量排第三，可能反映了藻类在氮源充足时优先合成蛋白质、氮源受限时转向脂质积累的代谢策略。

→ 输出：`results/feature_selection_results.xlsx`、`results/feature_selection_comparison.png`

---

## 文件清单

| 文件 | 说明 |
|------|------|
| `data/raw/row_data.xlsx` | 原始数据 |
| `data/processed/data_cleaned.xlsx` | 缺失值填充后 |
| `data/processed/data_featured.xlsx` | 特征工程后 |
| `data/processed/data_final.xlsx` | 异常值处理后 |
| `data/processed/data_standardized.xlsx` | 标准化后 |
| `results/feature_selection_results.xlsx` | 特征筛选详细结果 |
| `results/feature_selection_comparison.png` | 四种方法对比图 |
| `notebooks/00_full_pipeline.ipynb` | 完整处理代码 |
